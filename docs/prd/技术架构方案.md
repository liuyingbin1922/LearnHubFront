# 错题收集整理工具 - 技术架构方案

## 技术栈选择对比

### 方案对比

| 技术栈 | 优势 | 劣势 | 适用场景 |
|--------|------|------|----------|
| **Next.js全栈 + SQLite** | - 部署简单<br>- 开发效率高<br>- 前后端统一 | - 并发能力有限<br>- 扩展性一般 | MVP验证、快速迭代 |
| **Next.js + FastAPI** | - Python OCR生态丰富<br>- PDF生成成熟<br>- 性能较好 | - 跨语言开发复杂<br>- 部署要求高 | 长期项目、功能完整 |
| **Next.js + NestJS** | - 工程化强<br>- TypeScript全栈<br>- 扩展性好 | - 学习成本高<br>- 开发周期长 | 大型团队、规范开发 |

### 推荐方案：Next.js + FastAPI

**选择理由**：
1. Python在OCR和PDF处理方面生态成熟
2. 前后端分离，便于团队协作
3. 扩展性好，后续可加入更多AI能力
4. 技术栈稳定，社区支持好

## 系统架构设计

### 整体架构图
```
┌─────────────────────────────────────────────────────────┐
│                     前端 (Next.js)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  错题集管理   │  │  错题录入     │  │  PDF导出     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│         │                │                │             │
│         └────────────────┼────────────────┘             │
│                          │                            │
│                   ┌──────▼───────┐                    │
│                   │  API网关     │                    │
│                   │ (Next.js)    │                    │
│                   └──────┬───────┘                    │
└──────────────────────────┼─────────────────────────────┘
                           │
                           │ HTTP/REST
                           │
┌──────────────────────────┼─────────────────────────────┐
│                  后端 (FastAPI)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  用户管理     │  │  错题管理     │  │  OCR服务     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│         │                │                │             │
│         └────────────────┼────────────────┘             │
│                          │                            │
│                   ┌──────▼───────┐                    │
│                   │   业务逻辑    │                    │
│                   └──────┬───────┘                    │
└──────────────────────────┼─────────────────────────────┘
                           │
┌──────────────────────────┼─────────────────────────────┐
│                    数据存储层                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ PostgreSQL   │  │  MinIO/S3   │  │  Redis      │  │
│  │ (主数据库)    │  │  (图片存储)   │  │  (缓存)      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 架构说明
- **前端**：Next.js提供UI和基础交互
- **API网关**：Next.js API Routes处理简单接口，转发复杂业务到FastAPI
- **后端**：FastAPI处理核心业务逻辑
- **存储**：PostgreSQL存储结构化数据，MinIO存储图片，Redis缓存热点数据

## 详细技术方案

### 前端技术方案

#### 项目结构
```
frontend/
├── app/                    # Next.js App Router
│   ├── collections/        # 错题集相关页面
│   ├── problems/          # 错题相关页面
│   └── api/               # API Routes (简单接口)
├── components/            # 可复用组件
│   ├── ui/                # 基础UI组件
│   ├── Cropper/          # 图片裁剪组件
│   └── Upload/           # 上传组件
├── lib/                   # 工具库
│   ├── api.ts            # API调用封装
│   ├── utils.ts          # 通用工具
│   └── types.ts          # TypeScript类型
└── styles/               # 样式文件
```

#### 关键技术实现

**1. 图片裁剪组件**
```typescript
// 使用 react-easy-crop
import Cropper from 'react-easy-crop';

const ImageCropper = ({ imageSrc, onCropComplete }) => {
  // 实现裁剪逻辑
  // 输出裁剪参数和裁剪后图片
};
```

**2. 文件上传**
```typescript
// 使用 FormData 上传
const uploadImage = async (file: File) => {
  const formData = new FormData();
  formData.append('file', file);

  const response = await fetch('/api/upload', {
    method: 'POST',
    body: formData
  });

  return response.json();
};
```

**3. 状态管理**
```typescript
// 使用 Zustand
import { create } from 'zustand';

const useProblemStore = create((set) => ({
  problems: [],
  addProblem: (problem) => set((state) => ({
    problems: [...state.problems, problem]
  })),
}));
```

### 后端技术方案

#### 项目结构
```
backend/
├── app/
│   ├── api/               # API路由
│   │   ├── v1/
│   │   │   ├── collections.py
│   │   │   ├── problems.py
│   │   │   └── ocr.py
│   │   └── deps.py        # 依赖注入
│   ├── core/              # 核心配置
│   ├── models/            # 数据模型
│   ├── schemas/           # Pydantic模式
│   ├── services/          # 业务逻辑
│   │   ├── ocr_service.py
│   │   ├── pdf_service.py
│   │   └── storage_service.py
│   └── utils/             # 工具函数
├── alembic/               # 数据库迁移
└── requirements.txt
```

#### 关键技术实现

**1. OCR服务集成**
```python
# 使用百度OCR API
import baidu_ocr

class OCRService:
    def __init__(self):
        self.client = baidu_ocr.Client(
            app_id=os.getenv('BAIDU_APP_ID'),
            api_key=os.getenv('BAIDU_API_KEY'),
            secret_key=os.getenv('BAIDU_SECRET_KEY')
        )

    async def recognize(self, image_url: str) -> str:
        # 调用OCR API
        # 返回识别文本
        pass
```

**2. PDF生成**
```python
# 使用 Puppeteer 生成PDF
from pyppeteer import launch
import asyncio

class PDFService:
    async def generate_pdf(self, problems: List[Problem]) -> bytes:
        html = self.render_template(problems)

        browser = await launch()
        page = await browser.newPage()
        await page.setContent(html)
        pdf = await page.pdf({
            'format': 'A4',
            'printBackground': True
        })
        await browser.close()

        return pdf
```

**3. 图片存储**
```python
# 使用 MinIO
from minio import Minio

class StorageService:
    def __init__(self):
        self.client = Minio(
            "localhost:9000",
            access_key=os.getenv('MINIO_ACCESS_KEY'),
            secret_key=os.getenv('MINIO_SECRET_KEY'),
            secure=False
        )

    async def upload_image(self, file: bytes, filename: str) -> str:
        # 上传到MinIO
        # 返回访问URL
        pass
```

### 数据库设计

#### 表结构定义

**collections 表**
```sql
CREATE TABLE collections (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL DEFAULT 1,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_collections_user_id ON collections(user_id);
```

**problems 表**
```sql
CREATE TABLE problems (
    id SERIAL PRIMARY KEY,
    collection_id INTEGER NOT NULL,
    original_image_url TEXT,
    cropped_image_url TEXT,
    ocr_text TEXT,
    note TEXT,
    tags JSONB,
    order_index INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (collection_id) REFERENCES collections(id) ON DELETE CASCADE
);

CREATE INDEX idx_problems_collection_id ON problems(collection_id);
CREATE INDEX idx_problems_tags ON problems USING GIN(tags);
```

#### 迁移脚本
```bash
# 使用 Alembic 进行数据库迁移
alembic init alembic
alembic revision --autogenerate -m "initial"
alembic upgrade head
```

### 部署方案

#### 开发环境
```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - API_URL=http://backend:8000

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/dbname
      - MINIO_ENDPOINT=minio:9000

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=dbname
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass

  minio:
    image: minio/minio
    command: server /data
    ports:
      - "9000:9000"
      - "9001:9001"
```

#### 生产环境
- **前端**：Vercel / Netlify 部署
- **后端**：AWS ECS / Google Cloud Run / 阿里云容器服务
- **数据库**：RDS PostgreSQL
- **存储**：AWS S3 / 阿里云OSS
- **监控**：Prometheus + Grafana

### 性能优化策略

#### 前端优化
1. **图片优化**
   - 使用 WebP 格式
   - 压缩图片大小
   - 懒加载

2. **代码分割**
   ```typescript
   // 动态导入
   const PDFExporter = dynamic(
     () => import('./PDFExporter'),
     { loading: () => <Loading /> }
   );
   ```

3. **缓存策略**
   - React Query 缓存API数据
   - Service Worker 缓存静态资源

#### 后端优化
1. **数据库优化**
   - 索引优化
   - 连接池
   - 查询优化

2. **OCR优化**
   - 队列处理异步任务
   - 结果缓存
   - 批量处理

3. **PDF生成优化**
   - 异步生成
   - 增量更新
   - 模板缓存

### 安全方案

#### 身份认证
- JWT Token
- OAuth 2.0 (可选)

#### 数据安全
- 图片上传验证
- SQL注入防护
- XSS防护
- CSRF防护

#### 存储安全
- MinIO访问控制
- 数据加密存储
- 定期备份

## 开发计划

### Sprint 1: 基础框架 (2周)
- [ ] 项目初始化
- [ ] 开发环境搭建
- [ ] 基础组件开发
- [ ] 数据库设计

### Sprint 2: 核心功能 (3周)
- [ ] 错题集CRUD
- [ ] 图片上传
- [ ] 基础UI开发

### Sprint 3: OCR集成 (2周)
- [ ] OCR服务集成
- [ ] 前端编辑功能
- [ ] 错误处理

### Sprint 4: PDF导出 (2周)
- [ ] PDF模板设计
- [ ] 生成逻辑
- [ ] 性能优化

### Sprint 5: 测试与优化 (1周)
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- [ ] 部署上线

---

**技术负责人**：开发团队
**更新时间**：2026-01-13
**版本**：v1.0.0